<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Roadmap: Portfolio Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Suppress Tailwind CDN warning for this single-file app
      tailwind.config = {
        corePlugins: {
          preflight: false,
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--
      Chosen Palette: "Agentforce Dark" - A dark slate/gray background with vibrant blue-to-violet gradients for accents, inspired by modern AI-powered service branding.
      Application Structure Plan: A hierarchical planner with a globally-set AI Coach and a cloud-based backend. The UI is redesigned into a true Single-Page Application (SPA) with top-level navigation. Instead of a single scrolling page, the "Dashboard", "Phases", and "Journal" are now distinct views controlled by a main navigation bar. This addresses the user's feedback about the UI being "chunky" and creates a more focused, less congested user experience.
      Visualization & Content Choices:
        - Main Navigation: Goal: Organize/Navigate. Method: A sticky navigation bar. Interaction: Clicking a nav link shows the corresponding section and hides others. Justification: This is the core of the UI redesign, solving the "congested" layout issue by breaking the app into logical, manageable views.
      CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; /* slate-900 */ color: #cbd5e1; /* slate-300 */ }
        .main-nav-link { transition: all 0.2s; border-bottom: 2px solid transparent; }
        .main-nav-link.active { color: #f8fafc; border-bottom-color: #8b5cf6; }
        .main-nav-link:hover { color: #f8fafc; }
        .main-view { display: none; }
        .main-view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .kpi-card { background-color: #1e293b; /* slate-800 */ border: 1px solid #334155; }
        .phase-tab.active { border-bottom-color: #6366f1; /* indigo-500 */ color: #f8fafc; font-weight: 600; }
        .chart-container { position: relative; width: 100%; max-width: 200px; height: 200px; margin: auto; }
        .timeline-segment { transition: transform 0.2s, opacity 0.2s; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: #1e293b; border: 1px solid #475569; padding: 2rem; border-radius: 0.5rem; max-width: 90%; width: 600px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .gemini-button { background-image: linear-gradient(to right, #3b82f6, #8b5cf6); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s; box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .gemini-button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 0 25px rgba(139, 92, 246, 0.5); }
        .gemini-button:disabled { background-image: none; background-color: #475569; cursor: not-allowed; box-shadow: none; }
        .ai-action-button { background: none; border: none; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; font-size: 1.25rem; }
        .ai-action-button:hover { opacity: 1; color: #a5b4fc; }
        .milestone-item { display: flex; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #334155; }
        .subtask-list { margin-left: 2rem; border-left: 2px solid #334155; padding-left: 1rem; }
        .header-input { background: none; border: none; font-weight: bold; text-align: right; padding: 0.25rem; border-radius: 0.25rem; color: #e2e8f0; }
        .header-input:focus { outline: 2px solid #818cf8; background-color: #334155; }
        .reflection-card-container { perspective: 1000px; cursor: pointer; }
        .reflection-card { width: 100%; height: 200px; position: relative; transition: transform 0.6s; transform-style: preserve-3d; }
        .reflection-card.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 1rem; border-radius: 0.75rem; border: 1px solid #334155; }
        .card-front { background-color: #1e293b; }
        .card-back { background-color: #334155; transform: rotateY(180deg); overflow-y: auto; align-items: flex-start; text-align: left; }
        .main-nav-link .material-icons { vertical-align: middle; }
        .main-nav-link.active, .main-nav-link:hover { background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%); color: #fff !important; box-shadow: 0 2px 12px 0 rgba(139,92,246,0.15); }
        .kpi-card, .reflection-card, .modal-content { box-shadow: 0 4px 24px 0 rgba(16,16,32,0.18); transition: box-shadow 0.2s, transform 0.2s; }
        .kpi-card:hover, .reflection-card-container:hover .reflection-card { box-shadow: 0 8px 32px 0 rgba(139,92,246,0.25); transform: translateY(-2px) scale(1.03); }
        .add-milestone-input:focus { border-color: #8b5cf6; box-shadow: 0 0 0 2px #8b5cf6; }
        .empty-state {
            text-align: center;
            color: #a5b4fc;
            padding: 2rem 0;
            font-size: 1.2rem;
            opacity: 0.8;
        }
        /* Animated gradient background */
        @keyframes gradient-move {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }
        .animate-gradient-move {
          background-size: 200% 200%;
          animation: gradient-move 12s ease-in-out infinite;
        }
        /* Gradient text animation */
        @keyframes gradient-text {
          0%,100% { filter: brightness(1); }
          50% { filter: brightness(1.2) drop-shadow(0 0 16px #a78bfa); }
        }
        .animate-gradient-text { animation: gradient-text 3s infinite; }
        /* Fade in */
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 1.2s; }
        /* Glass nav effect */
        .glass-nav { box-shadow: 0 8px 32px 0 rgba(31, 41, 55, 0.25); border: 1.5px solid rgba(139,92,246,0.15); }
        /* Card glassmorphism */
        .kpi-card, .reflection-card, .modal-content, .bg-slate-800\/50 {
          background: rgba(30,41,59,0.85);
          box-shadow: 0 4px 32px 0 rgba(139,92,246,0.08);
          backdrop-filter: blur(6px);
        }
        /* Card hover */
        .kpi-card:hover, .reflection-card-container:hover .reflection-card {
          transform: scale(1.03) translateY(-2px);
          box-shadow: 0 8px 32px 0 rgba(139,92,246,0.18);
          transition: all 0.2s;
        }
        /* Button glow */
        .gemini-button {
          box-shadow: 0 0 16px 0 rgba(139,92,246,0.18);
          transition: box-shadow 0.2s, transform 0.2s;
        }
        .gemini-button:hover:not(:disabled) {
          box-shadow: 0 0 32px 0 rgba(139,92,246,0.32);
          transform: scale(1.04) translateY(-2px);
        }
        /* Timeline segment animation */
        .timeline-segment {
          transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
        }
        .timeline-segment:hover {
          transform: scale(1.05);
          box-shadow: 0 2px 12px 0 rgba(139,92,246,0.18);
          z-index: 2;
        }
        /* Confetti animation */
        .confetti {
          position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 1000;
        }
        /* Journal empty state */
        .journal-empty {
          display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 180px; color: #a5b4fc;
        }
        .journal-empty .material-icons {
          font-size: 3rem; margin-bottom: 0.5rem; color: #818cf8;
        }
        #project-hub-view .project-card {
          background: rgba(30,41,59,0.92);
          border: 1.5px solid #6366f1;
          border-radius: 1rem;
          box-shadow: 0 4px 24px 0 rgba(139,92,246,0.10);
          padding: 1.5rem;
          transition: box-shadow 0.2s, transform 0.2s;
          cursor: pointer;
          position: relative;
        }
        #project-hub-view .project-card:hover {
          box-shadow: 0 8px 32px 0 rgba(139,92,246,0.18);
          transform: scale(1.03) translateY(-2px);
        }
        .project-status {
          position: absolute; top: 1rem; right: 1rem;
          padding: 0.25rem 0.75rem;
          border-radius: 9999px;
          font-size: 0.9rem;
          font-weight: 600;
          color: #fff;
        }
        .status-inprogress { background: linear-gradient(90deg,#6366f1,#3b82f6); }
        .status-completed { background: linear-gradient(90deg,#14b8a6,#22d3ee); }
        .status-notstarted { background: linear-gradient(90deg,#64748b,#a5b4fc); }
        .project-progress-bar {
          height: 8px;
          border-radius: 4px;
          background: #334155;
          margin-top: 1rem;
          overflow: hidden;
        }
        .project-progress {
          height: 100%;
          border-radius: 4px;
          background: linear-gradient(90deg,#8b5cf6,#3b82f6);
          transition: width 0.4s;
        }
    </style>
</head>
<body class="text-slate-300 relative">

    <!-- Animated Gradient Background Accent -->
    <div class="fixed inset-0 -z-10 pointer-events-none">
      <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[120vw] h-[60vh] bg-gradient-to-tr from-blue-700/40 via-violet-600/30 to-fuchsia-500/20 blur-3xl animate-gradient-move"></div>
    </div>

    <!-- Hero Banner -->
    <section class="mb-8 flex flex-col items-center justify-center text-center py-8">
      <div class="inline-flex items-center gap-3 mb-2">
        <span class="material-icons text-5xl text-violet-400 animate-bounce">rocket_launch</span>
        <h1 class="text-4xl sm:text-5xl font-extrabold bg-gradient-to-r from-blue-400 via-violet-400 to-fuchsia-400 bg-clip-text text-transparent drop-shadow-lg animate-gradient-text">Portfolio Command Center</h1>
      </div>
      <p class="text-lg text-slate-400 max-w-xl mx-auto animate-fade-in">Your AI-powered project roadmap, journal, and coaching hub. Plan, track, and reflect with style.</p>
    </section>

    <div id="loading-screen" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-50" style="display: none;">
        <div class="text-center p-8">
            <h1 class="text-3xl font-bold text-slate-100 animate-pulse">Loading Project...</h1>
            <p class="text-slate-400 mt-2 mb-6">Authenticating and fetching your data.</p>
        </div>
    </div>
    
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6 flex justify-between items-center relative">
            <div class="flex items-center gap-3">
                <span class="inline-block bg-gradient-to-tr from-blue-500 via-violet-500 to-fuchsia-500 rounded-full p-2 shadow-lg animate-pulse">
                    <svg width="32" height="32" fill="none" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="#18181b"/><path d="M16 6v8l6 3" stroke="#8b5cf6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
                <h1 class="text-3xl sm:text-4xl font-bold text-slate-100 bg-gradient-to-r from-blue-400 via-violet-400 to-fuchsia-400 bg-clip-text text-transparent animate-gradient-x">Portfolio Command Center</h1>
            </div>
            <div class="text-right space-y-2">
                 <div>
                    <label for="coach-selector" class="text-sm text-slate-400">AI Coach:</label>
                    <select id="coach-selector" class="header-input w-28 border border-slate-600 rounded-md bg-slate-800"></select>
                </div>
                 <div>
                    <label for="user-name-input" class="text-sm text-slate-400">Welcome,</label>
                    <input type="text" id="user-name-input" class="header-input w-28">
                    <button id="sign-out-btn" class="text-xs text-red-500 hover:underline ml-2">(Sign Out)</button>
                </div>
            </div>
            <div id="confetti-canvas" class="pointer-events-none absolute inset-0 z-50" style="display:none;"></div>
        </header>

        <nav class="bg-slate-800/50 backdrop-blur-sm rounded-lg p-2 mb-8 flex items-center justify-center space-x-4 md:space-x-8 sticky top-4 z-40 border border-slate-700 shadow-lg glass-nav">
            <button id="back-to-hub-btn" class="main-nav-link text-slate-300 px-4 py-2 font-semibold flex items-center gap-2 hidden">
        <span class="material-icons">arrow_back</span>Back to Hub
    </button>
            <button class="main-nav-link text-slate-300 px-4 py-2 font-semibold flex items-center gap-2" data-view="dashboard">
                <span class="material-icons">dashboard</span>Dashboard
            </button>
            <button class="main-nav-link text-slate-300 px-4 py-2 font-semibold flex items-center gap-2" data-view="phases">
                <span class="material-icons">timeline</span>Phases
            </button>
            <button class="main-nav-link text-slate-300 px-4 py-2 font-semibold flex items-center gap-2" data-view="journal">
                <span class="material-icons">menu_book</span>Journal
            </button>
        </nav>
        
        <main>
            <div id="dashboard-view" class="main-view">
                <section id="kpi-section" class="mb-10">
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold text-slate-100">Project Status Overview</h2><p class="text-slate-400 max-w-2xl mx-auto">This section provides a real-time summary of the project's progress. Add or complete tasks and sub-tasks to see the chart update instantly.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="kpi-card flex flex-col items-center justify-center"><h3 class="font-semibold text-slate-400 text-center mb-2">Overall Progress</h3><div class="chart-container"><canvas id="progressChart"></canvas></div></div>
                        <div class="kpi-card flex flex-col items-center justify-center text-center"><h3 class="font-semibold text-slate-400 mb-2">Current Priority</h3><p id="current-phase-text" class="text-2xl font-bold text-amber-400"></p></div>
                        <div class="kpi-card flex flex-col items-center justify-center text-center"><h3 class="font-semibold text-slate-400 mb-2">Next Critical Task</h3><p id="next-task-text" class="text-lg font-semibold text-slate-100"></p></div>
                        <div class="kpi-card flex flex-col items-center justify-center text-center bg-slate-800/50"><h3 class="font-semibold text-violet-300 mb-3">AI Assistant</h3><button id="generate-status-update" class="gemini-button">✨ Generate Status Update</button></div>
                    </div>
                </section>
                <section id="timeline-section" class="mb-12">
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold text-slate-100">Project Timeline</h2><p class="text-slate-400 max-w-2xl mx-auto">A visual overview of the project phases. Status is updated automatically as you complete tasks.</p></div>
                    <div class="w-full bg-slate-800 p-2 rounded-xl border border-slate-700"><div id="visual-timeline" class="flex rounded-lg overflow-hidden h-10"></div></div>
                </section>
            </div>

            <div id="phases-view" class="main-view">
                 <section id="phases-section" class="bg-slate-800 p-6 rounded-xl border border-slate-700 mb-12">
                    <div class="text-left mb-6"><h2 class="text-2xl font-bold text-slate-100">Phase Details</h2><p class="text-slate-400">Manage tasks and sub-tasks. Use ✨ to break down tasks, and 🧠 to get coaching on a specific task.</p></div>
                    <div id="phase-tabs" class="border-b border-slate-700 mb-6 flex flex-wrap -mb-px"></div>
                    <div id="phase-contents"></div>
                </section>
            </div>

             <div id="journal-view" class="main-view">
                <section id="journal-section" class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center mb-6">
                        <div><h2 class="text-2xl font-bold text-slate-100">Reflection Board</h2><p class="text-slate-400">Review your past journal entries. Click a card to flip it and read the full reflection.</p></div>
                        <button id="summarize-journal" class="gemini-button bg-sky-500 hover:bg-sky-600">✨ Get Key Insights</button>
                    </div>
                    <div id="journal-entries-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>
            </div>

            <div id="project-hub-view" class="main-view active">
              <section class="mb-8 flex flex-col items-center justify-center text-center py-8">
                <h2 class="text-3xl font-bold text-slate-100 mb-2">Project Hub</h2>
                <p class="text-slate-400 mb-6 max-w-xl">Welcome, David! Manage all your projects from one place. Start a new project or dive into any existing one below.</p>
                <button id="new-project-btn" class="gemini-button mb-8 flex items-center gap-2"><span class="material-icons">add_circle</span>New Project</button>
                <div id="project-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-5xl"></div>
              </section>
            </div>
        </main>
    </div>

    <div id="ai-modal" class="modal-overlay">
        <div class="modal-content"><div class="flex justify-between items-center mb-4"><h3 id="modal-title" class="text-xl font-bold text-slate-100"></h3><button id="modal-close" class="text-2xl text-slate-400 hover:text-white">&times;</button></div><div id="modal-body" class="text-slate-300 prose-invert max-w-none"></div></div>
    </div>

    <div id="new-project-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-slate-100">Start a New Project</h3>
          <button id="close-new-project-modal" class="text-2xl text-slate-400 hover:text-white">&times;</button>
        </div>
        <div class="mb-4">
          <button id="guided-onboarding-btn" class="gemini-button w-full mb-2 flex items-center gap-2 justify-center"><span class="material-icons">psychology</span>Guided Onboarding (AI)</button>
          <button id="quick-start-btn" class="gemini-button w-full flex items-center gap-2 justify-center"><span class="material-icons">flash_on</span>Quick Start</button>
        </div>
        <div id="new-project-form" class="hidden">
          <input id="project-name-input" type="text" class="add-milestone-input w-full mb-2" placeholder="Project Name">
          <textarea id="project-desc-input" class="add-milestone-input w-full mb-2" placeholder="Project Description"></textarea>
          <button id="create-project-btn" class="gemini-button w-full">Create Project</button>
        </div>
        <div id="onboarding-ai" class="hidden">
          <p class="mb-2 text-slate-300">AI will help you define your project. (Coming soon!)</p>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script>
        console.log('JavaScript is loading...');
        console.log('Firebase available:', typeof firebase !== 'undefined');

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM Content Loaded event fired');

            // Immediate UI initialization - don't wait for Firebase
            const appContainer = document.getElementById('app-container');
            const hubView = document.getElementById('project-hub-view');

            // Show the app immediately
            if (appContainer) {
                appContainer.classList.remove('hidden');
                appContainer.style.display = 'block';
                console.log('App container shown immediately');
            }

            // Show the hub view immediately
            if (hubView) {
                hubView.classList.add('active');
                hubView.style.display = 'block';
                console.log('Hub view shown immediately');
            }
            const firebaseConfig = {
              apiKey: "AIzaSyASzOMggLbJRfuVsA3Xu0sYCOmnIM_Ed04",
              authDomain: "project-roadmap-app.firebaseapp.com",
              projectId: "project-roadmap-app",
              storageBucket: "project-roadmap-app.appspot.com",
              messagingSenderId: "77678645722",
              appId: "1:77678645722:web:9c4095c0d81d3f32d870e3"
            };

            console.log('Initializing Firebase...');
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            console.log('Firebase initialized successfully');

            let roadmapData = null;
            let dbRef = null;

            // --- Project Hub Data Model ---
            let projects = [];
            let selectedProjectId = null;
            let projectsRef = null;

            const ui = {
                loadingScreen: document.getElementById('loading-screen'),
                appContainer: document.getElementById('app-container'),
                signOutBtn: document.getElementById('sign-out-btn'),
                userNameInput: document.getElementById('user-name-input'),
                tabs: document.getElementById('phase-tabs'),
                contents: document.getElementById('phase-contents'),
                timeline: document.getElementById('visual-timeline'),
                modal: document.getElementById('ai-modal'),
                modalTitle: document.getElementById('modal-title'),
                modalBody: document.getElementById('modal-body'),
                modalClose: document.getElementById('modal-close'),
                journalList: document.getElementById('journal-entries-list'),
                coachSelector: document.getElementById('coach-selector'),
                summarizeBtn: document.getElementById('summarize-journal')
            };
            
            const personas = {
                Debbie: { name: 'Debbie', style: 'direct, concise, and to-the-point' },
                Loraine: { name: 'Loraine', style: 'supportive, gentle, and encouraging' },
                Jonas: { name: 'Jonas', style: 'insightful, firm, and fatherly' }
            };

            const statusConfig = { 'Complete': { bgColor: 'bg-teal-500' }, 'In Progress': { bgColor: 'bg-amber-500' }, 'To Do': { bgColor: 'bg-slate-500' } };
            let progressChartInstance = null;
            
            async function saveDataToFirestore() {
                if (!dbRef) return;
                try { await dbRef.set(roadmapData); } catch (e) { console.error("Error saving data: ", e); }
            }

            async function loadDataFromFirestore(user) {
                const appId = 'default-app-id';
                const docPath = `artifacts/${appId}/users/${user.uid}/roadmapData/state`;
                dbRef = db.doc(docPath);
                const docSnap = await dbRef.get();
                if (docSnap.exists) {
                    roadmapData = docSnap.data();
                } else {
                    roadmapData = {
                        user: { name: user.isAnonymous ? 'Anonymous User' : (user.displayName || 'User') }, activeCoach: 'Jonas',
                        phases: [ { id: 'phase1', title: 'Phase 1: Foundation', milestones: [ { text: 'Setup Project', status: 'To Do' } ] } ],
                        journal: []
                    };
                    await saveDataToFirestore();
                }
                initApp();
            }
            
            function initApp() {
                ui.loadingScreen.style.opacity = '0';
                setTimeout(() => { ui.loadingScreen.style.display = 'none'; }, 500);
                ui.appContainer.classList.remove('hidden');
                initSelectors();
                renderRoadmap();
                setupNavigation();
            }
            
            function initSelectors() {
                if (!roadmapData) return;
                ui.userNameInput.value = roadmapData.user.name;
                ui.coachSelector.innerHTML = Object.keys(personas).map(key => `<option value="${key}">${personas[key].name}</option>`).join('');
                if(roadmapData.activeCoach) {
                    ui.coachSelector.value = roadmapData.activeCoach;
                }
            }

            function renderMilestone(milestone, phaseIndex, milestoneIndex, isSubtask = false) {
                const isComplete = milestone.status === 'Complete';
                const hasSubtasks = milestone.subTasks && milestone.subTasks.length > 0;
                const checkboxDisabled = hasSubtasks;
                const breakdownButton = !hasSubtasks ? `<button class="ai-action-button" data-action="breakdown" data-phase-index="${phaseIndex}" data-milestone-index="${milestoneIndex}" title="Breakdown Task">✨</button>` : '';
                const coachButton = !isComplete ? `<button class="ai-action-button" data-action="coach" data-phase-index="${phaseIndex}" data-milestone-index="${milestoneIndex}" title="Get Coaching">🧠</button>` : '';
                
                let subtaskHTML = '';
                if (hasSubtasks) subtaskHTML = `<ul class="subtask-list mt-2">${milestone.subTasks.map((sub, subIndex) => renderMilestone(sub, phaseIndex, milestoneIndex, subIndex)).join('')}</ul>`;
                const dataAttrs = isSubtask === false ? `data-phase-index="${phaseIndex}" data-milestone-index="${milestoneIndex}"` : `data-phase-index="${phaseIndex}" data-milestone-index="${milestoneIndex}" data-subtask-index="${isSubtask}"`;
                
                return `<li class="milestone-item-container"><div class="milestone-item"><input type="checkbox" class="milestone-checkbox" ${dataAttrs} ${isComplete ? 'checked' : ''} ${checkboxDisabled ? 'disabled' : ''}><div class="flex-grow"><p class="font-medium text-slate-100 ${isComplete ? 'line-through text-slate-400' : ''}">${milestone.text}</p></div><div class="ml-auto flex items-center gap-x-2">${breakdownButton}${coachButton}</div></div>${subtaskHTML}</li>`;
            }

            function renderJournal() {
                ui.journalList.innerHTML = '';
                if(!roadmapData.journal) roadmapData.journal = [];
                if(roadmapData.journal.length === 0) {
                  ui.journalList.innerHTML = `<div class="journal-empty"><span class="material-icons">menu_book</span><p>No journal entries yet.<br><span class='text-slate-400'>Reflect on your progress and log your first insight!</span></p></div>`;
                  return;
                }
                roadmapData.journal.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(item => {
                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'reflection-card-container';
                    const card = document.createElement('div');
                    card.className = 'reflection-card';
                    const front = document.createElement('div');
                    front.className = 'card-face card-front';
                    const topicMatch = item.entry.match(/<strong>Coaching on: "(.*?)"<\/strong>/);
                    const topic = topicMatch ? topicMatch[1] : 'General Entry';
                    const formattedDate = new Date(item.date).toLocaleDateString('en-ZA', { day: 'numeric', month: 'long', year: 'numeric' });
                    front.innerHTML = `<p class="text-slate-400 text-sm">${formattedDate}</p><p class="text-center font-bold text-lg text-slate-100">${topic}</p><p class="mt-4 text-xs text-slate-500">(Click to review)</p>`;
                    const back = document.createElement('div');
                    back.className = 'card-face card-back';
                    back.innerHTML = `<div class="w-full h-full text-slate-300">${item.entry.replace(/\n/g, '<br>')}</div>`;
                    card.appendChild(front);
                    card.appendChild(back);
                    cardContainer.appendChild(card);
                    ui.journalList.appendChild(cardContainer);
                    cardContainer.addEventListener('click', () => card.classList.toggle('is-flipped'));
                });
            }

            function renderRoadmap() {
                if (!roadmapData) return;
                const activePhaseTab = document.querySelector('.phase-tab.active');
                const activePhaseId = activePhaseTab ? activePhaseTab.dataset.phaseId : (roadmapData.phases.length > 0 ? roadmapData.phases[0].id : null);
                
                ui.tabs.innerHTML = '';
                ui.contents.innerHTML = '';
                ui.timeline.innerHTML = '';

                let totalMilestones = 0, completedMilestones = 0;
                const countTasks = (milestones) => { milestones.forEach(m => { if (m.subTasks && m.subTasks.length > 0) countTasks(m.subTasks); else { totalMilestones++; if (m.status === 'Complete') completedMilestones++; } }); };
                roadmapData.phases.forEach(p => countTasks(p.milestones));

                roadmapData.phases.forEach((phase, phaseIndex) => {
                    const tab = document.createElement('button');
                    tab.className = 'phase-tab text-slate-400 py-4 px-6 block hover:text-slate-200 focus:outline-none';
                    tab.textContent = `Phase ${phaseIndex + 1}`;
                    tab.dataset.phaseId = phase.id;
                    ui.tabs.appendChild(tab);

                    const content = document.createElement('div');
                    content.id = phase.id;
                    content.className = 'phase-content p-2';
                    const milestoneHTML = phase.milestones.map((m, mi) => renderMilestone(m, phaseIndex, mi)).join('');
                    content.innerHTML = `<h3 class="text-2xl font-bold text-slate-100 mb-2">${phase.title}</h3><ul>${milestoneHTML}</ul><div class="mt-4 flex gap-2"><input type="text" placeholder="Add a new milestone..." class="add-milestone-input flex-grow p-2 border rounded-md bg-slate-700 border-slate-600 text-slate-200 placeholder-slate-400"><button class="add-milestone-button gemini-button text-sm" data-phase-index="${phaseIndex}">Add Task</button></div>`;
                    ui.contents.appendChild(content);

                    const allMilestonesComplete = phase.milestones.every(m => m.status === 'Complete');
                    phase.status = allMilestonesComplete ? 'Complete' : (phase.milestones.some(m => m.status !== 'To Do') ? 'In Progress' : 'To Do');
                    
                    const phaseStatusConfig = statusConfig[phase.status];
                    const segment = document.createElement('div');
                    segment.className = `timeline-segment flex-1 ${phaseStatusConfig.bgColor} flex items-center justify-center text-white font-bold text-sm cursor-pointer`;
                    segment.textContent = `Phase ${phaseIndex + 1}`;
                    segment.dataset.phaseId = phase.id;
                    ui.timeline.appendChild(segment);
                });

                updateKPIs();
                setupChart(totalMilestones, completedMilestones);
                renderJournal();
                showPhase(activePhaseId);
                
                // Confetti on all phases complete
                const allPhasesComplete = roadmapData.phases.every(p => p.status === 'Complete');
                if (allPhasesComplete) launchConfetti();
            }
            
            function getNextTask() {
                const currentPhase = roadmapData.phases.find(p => p.status === 'In Progress');
                if (currentPhase) {
                    const findNext = (milestones) => {
                        for(const m of milestones) {
                            if (m.status !== 'Complete') {
                                if (m.subTasks && m.subTasks.length > 0) { const subNext = findNext(m.subTasks); if(subNext) return subNext; } else { return m; }
                            }
                        }
                        return null;
                    }
                    return findNext(currentPhase.milestones);
                }
                return null;
            }

            function updateKPIs() {
                const currentPhase = roadmapData.phases.find(p => p.status === 'In Progress');
                const nextTask = getNextTask();
                document.getElementById('current-phase-text').textContent = currentPhase ? currentPhase.title : 'All Phases Complete!';
                document.getElementById('next-task-text').textContent = nextTask ? nextTask.text : 'Review Finalization';
            }

            function setupChart(total, completed) {
                if (progressChartInstance) progressChartInstance.destroy();
                const overallProgress = total > 0 ? Math.round((completed / total) * 100) : 0;
                const ctx = document.getElementById('progressChart').getContext('2d');
                progressChartInstance = new Chart(ctx, {
                    type: 'doughnut', data: { datasets: [{ data: [overallProgress, 100 - overallProgress], backgroundColor: ['#8b5cf6', '#334155'], borderWidth: 0, hoverOffset: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: false } } },
                    plugins: [{ id: 'doughnutText', afterDraw(chart) {
                        const { width, height, ctx } = chart; ctx.restore(); const fontSize = (height / 114).toFixed(2);
                        ctx.font = `bold ${fontSize}em Inter, sans-serif`; ctx.textBaseline = 'middle'; ctx.fillStyle = '#c4b5fd';
                        const text = `${overallProgress}%`; const textX = Math.round((width - ctx.measureText(text).width) / 2);
                        ctx.fillText(text, textX, height / 2); ctx.save();
                    }}]
                });
            }
            
            function showPhase(phaseId) {
                if (!phaseId) return;
                document.querySelectorAll('.phase-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.phase-content').forEach(c => c.classList.remove('active'));
                const tab = document.querySelector(`.phase-tab[data-phase-id="${phaseId}"]`);
                const content = document.getElementById(phaseId);
                if (tab) tab.classList.add('active');
                if (content) content.classList.add('active');
            }
            
            async function callGemini(prompt, button) {
                if(button) button.disabled = true;
                ui.modalTitle.textContent = "AI Assistant";
                ui.modalBody.innerHTML = '<p class="text-center animate-pulse">Generating response, please wait...</p>';
                ui.modal.classList.add('visible');
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "AIzaSyD2uTV8oHgQalPUE2j1E5Z-lliXEymkEKk";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts.length > 0) return result.candidates[0].content.parts[0].text;
                    else throw new Error("Invalid response format from API.");
                } catch (error) {
                    showErrorModal('AI request failed. Please try again.');
                    return null;
                } finally { if(button) button.disabled = false; }
            }
            
            function setupNavigation() {
                const navLinks = document.querySelectorAll('.main-nav-link');
                const views = document.querySelectorAll('.main-view');
                const backToHubBtn = document.getElementById('back-to-hub-btn');

                function showView(viewId) {
                    views.forEach(view => {
                        view.classList.toggle('active', view.id === viewId + '-view');
                    });
                    navLinks.forEach(link => {
                        link.classList.toggle('active', link.dataset.view === viewId);
                    });
                    // Show/hide Back to Hub button
                    if (backToHubBtn) {
                        if (viewId === 'dashboard' || viewId === 'phases' || viewId === 'journal') {
                            backToHubBtn.classList.remove('hidden');
                        } else {
                            backToHubBtn.classList.add('hidden');
                        }
                    }
                }

                navLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        showView(e.target.dataset.view);
                    });
                });
                showView('dashboard');
            }

            ui.signOutBtn.addEventListener('click', () => signOut(auth));

            ui.coachSelector.addEventListener('change', (e) => {
                roadmapData.activeCoach = e.target.value;
                saveDataToFirestore();
            });
            
            ui.userNameInput.addEventListener('change', (e) => {
                if(roadmapData) {
                    roadmapData.user.name = e.target.value || 'User';
                    saveDataToFirestore();
                }
            });

            ui.contents.addEventListener('click', async e => {
                const button = e.target.closest('.ai-action-button');
                if (button) {
                    const { action, phaseIndex, milestoneIndex } = button.dataset;
                    const milestone = roadmapData.phases[phaseIndex].milestones[milestoneIndex];
                    const taskText = milestone.text;
                    
                    if (action === 'breakdown') {
                        const prompt = `You are a project management expert. Break down the following complex task into a checklist of smaller, actionable sub-tasks. Present the output as a simple list where each sub-task is on a new line. Do not use bullet points or numbering. Task: "${taskText}"`;
                        const resultText = await callGemini(prompt, button);
                        if (resultText) {
                            const subTasks = resultText.split('\n').filter(t => t.trim() !== '');
                            ui.modalTitle.textContent = `Breakdown for: "${taskText}"`;
                            ui.modalBody.innerHTML = `<p class="mb-4">Select sub-tasks to add to the plan.</p><div id="subtask-list">${subTasks.map(st => `<div class="flex items-center my-1"><input type="checkbox" class="subtask-checkbox" checked value="${st}"><label class="ml-2">${st}</label></div>`).join('')}</div><button id="add-subtasks-button" class="gemini-button mt-4">Add Selected to Plan</button>`;
                            document.getElementById('add-subtasks-button').onclick = () => {
                                const selectedSubtasks = Array.from(document.querySelectorAll('.subtask-checkbox:checked')).map(cb => ({ text: cb.value, status: 'To Do' }));
                                milestone.subTasks = [...(milestone.subTasks || []), ...selectedSubtasks];
                                milestone.status = 'In Progress';
                                ui.modal.classList.remove('visible');
                                renderRoadmap();
                                saveDataToFirestore();
                            };
                        }
                    } else if (action === 'coach') {
                        const personaKey = roadmapData.activeCoach;
                        const persona = personas[personaKey];
                        const phase = roadmapData.phases[phaseIndex].title;
                        const userName = roadmapData.user.name;
                        const prompt = `You are an expert project management coach named ${persona.name}. Your coaching style is ${persona.style}. Your user's name is ${userName}. The user is working on the task "${taskText}" during the phase "${phase}". First, in a friendly and simple tone, explain a key challenge or concept related to this task. Then, on a new line, ask a single, clear, and simple question to guide their thinking about that challenge. The entire response should be two short paragraphs.`;
                        
                        const aiResponse = await callGemini(prompt, button);
                        if(aiResponse) {
                            const [explanation, question] = aiResponse.split('\n').filter(s => s.trim() !== '');
                            ui.modalTitle.textContent = `Coaching Session with ${persona.name}`;
                            ui.modalBody.innerHTML = `<div class="p-4 bg-slate-700 rounded-lg mb-4"><p class="font-semibold text-slate-200">Coach ${persona.name}'s Insight:</p><p class="text-slate-300">${explanation || ''}</p><p class="font-semibold mt-3 text-slate-200">Guiding Question:</p><p class="text-lg italic text-slate-100">"${question || ''}"</p></div><label for="micro-journal-input" class="font-semibold text-slate-200">Your Reflection:</label><textarea id="micro-journal-input" class="w-full p-2 mt-1 border rounded-md bg-slate-700 border-slate-600 text-slate-200"></textarea><button id="log-coaching-session" class="gemini-button mt-4">Log to Journal</button>`;
                            document.getElementById('log-coaching-session').onclick = () => {
                                const answer = document.getElementById('micro-journal-input').value;
                                if (answer.trim() !== '') {
                                    const journalEntry = `<strong>Coaching on: "${taskText}"</strong><br><p class="italic text-slate-400">Insight from ${persona.name}: ${explanation}</p><p class="italic text-slate-400">Q: ${question}</p><p>A: ${answer}</p>`;
                                    roadmapData.journal.push({ date: new Date().toISOString(), entry: journalEntry });
                                    ui.modal.classList.remove('visible');
                                    renderJournal();
                                    saveDataToFirestore();
                                }
                            };
                        }
                    }
                }

                if (e.target.matches('.milestone-checkbox')) {
                    const { phaseIndex, milestoneIndex, subtaskIndex } = e.target.dataset;
                    const isChecked = e.target.checked;
                    const milestone = roadmapData.phases[phaseIndex].milestones[milestoneIndex];
                    if (subtaskIndex !== undefined) {
                        milestone.subTasks[subtaskIndex].status = isChecked ? 'Complete' : 'To Do';
                        const allSubtasksComplete = milestone.subTasks.every(st => st.status === 'Complete');
                        milestone.status = allSubtasksComplete ? 'Complete' : 'In Progress';
                    } else {
                        milestone.status = isChecked ? 'Complete' : 'To Do';
                    }
                    renderRoadmap();
                    saveDataToFirestore();
                }

                if (e.target.matches('.add-milestone-button')) {
                    const { phaseIndex } = e.target.dataset;
                    const input = e.target.previousElementSibling;
                    if (input && input.value.trim() !== "") {
                        roadmapData.phases[phaseIndex].milestones.push({ text: input.value.trim(), status: 'To Do' });
                        input.value = "";
                        renderRoadmap();
                        saveDataToFirestore();
                    }
                }
            });
            
            ui.tabs.addEventListener('click', (e) => { if (e.target.matches('.phase-tab')) showPhase(e.target.dataset.phaseId); });
            ui.timeline.addEventListener('click', (e) => { if (e.target.matches('.timeline-segment')) showPhase(e.target.dataset.phaseId); });
            ui.modalClose.addEventListener('click', () => ui.modal.classList.remove('visible'));
            ui.modal.addEventListener('click', (e) => { if (e.target === ui.modal) ui.modal.classList.remove('visible'); });
            
            ui.summarizeBtn.addEventListener('click', async e => {
                 if (!roadmapData.journal || roadmapData.journal.length === 0) {
                    ui.modalTitle.textContent = "Journal Summary";
                    ui.modalBody.innerHTML = "<p>There are no journal entries to summarize yet.</p>";
                    ui.modal.classList.add('visible');
                    return;
                }
                const fullJournalText = roadmapData.journal.map(item => `On ${new Date(item.date).toLocaleDateString()}:\n${item.entry.replace(/<[^>]*>/g, ' ')}`).join('\n\n---\n\n');
                const prompt = `You are a project analyst. Based on the following project journal entries, identify the most important recurring themes, key challenges, and critical decisions. Summarize them as clear, concise bullet points. Journal: \n\n${fullJournalText}`;
                const resultText = await callGemini(prompt, e.target);
                if (resultText) {
                    ui.modalTitle.textContent = "Journal Key Insights";
                    ui.modalBody.innerHTML = resultText.replace(/\n/g, '<br>');
                }
            });

            document.getElementById('generate-status-update').addEventListener('click', async (e) => {
                let total = 0, completed = 0;
                const count = (m) => { m.forEach(i => { if(i.subTasks && i.subTasks.length > 0) count(i.subTasks); else { total++; if(i.status === 'Complete') completed++; } }); };
                roadmapData.phases.forEach(p => count(p.milestones));
                const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
                const currentPhase = roadmapData.phases.find(p => p.status === 'In Progress');
                const prompt = `Write a brief, professional status update for the "Portfolio Command Center" project. Data: Overall Progress: ${progress}%. Current Priority Phase: "${currentPhase ? currentPhase.title : 'None'}".`;
                const resultText = await callGemini(prompt, e.target);
                if (resultText) { ui.modalTitle.textContent = "AI-Generated Status Update"; ui.modalBody.innerHTML = resultText.replace(/\n/g, '<br>'); }
            });

            // --- Project Hub UI Functions ---
            function renderProjectHub() {
              console.log('renderProjectHub called');
              const hubView = document.getElementById('project-hub-view');
              const appContainer = document.getElementById('app-container');
              console.log('Hub view element:', hubView);
              console.log('App container element:', appContainer);

              // Show the app container first, then activate the hub view
              appContainer.classList.remove('hidden');

              // Hide all other main views and show only the hub
              const allViews = document.querySelectorAll('.main-view');
              allViews.forEach(view => view.classList.remove('active'));

              hubView.classList.add('active');
              console.log('Hub view classes after adding active:', hubView.className);

              const backToHubBtn = document.getElementById('back-to-hub-btn');
              if (backToHubBtn) backToHubBtn.classList.add('hidden');
              const list = document.getElementById('project-list');
              list.innerHTML = '';
              console.log('Project list element:', list);
              console.log('Projects array:', projects);

              // Add Import button
              const importBtn = document.createElement('button');
              importBtn.className = 'gemini-button mb-4 flex items-center gap-2 justify-center';
              importBtn.innerHTML = `<span class='material-icons'>file_upload</span>Import Project`;
              importBtn.onclick = (e) => { e.stopPropagation(); showImportModal(); };
              list.appendChild(importBtn);
              if (projects.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-state';
                emptyDiv.innerHTML = `No projects yet. Click <b>New Project</b> or <b>Import Project</b> to get started!`;
                list.appendChild(emptyDiv);
                console.log('No projects, showing empty state');
                return;
              }
              console.log('Rendering', projects.length, 'projects');
              projects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'project-card';
                card.innerHTML = `
                  <div class="project-status ${project.status === 'Completed' ? 'status-completed' : project.status === 'In Progress' ? 'status-inprogress' : 'status-notstarted'}">${project.status}</div>
                  <h3 class="text-xl font-bold text-slate-100 mb-1">${project.name}</h3>
                  <p class="text-slate-400 mb-2">${project.description || ''}</p>
                  <div class="project-progress-bar"><div class="project-progress" style="width:${project.progress || 0}%"></div></div>
                  <div class="flex gap-2 mt-3">
                    <button class="gemini-button flex-1" onclick="event.stopPropagation(); editProject('${project.id}')"><span class="material-icons">edit</span>Edit</button>
                    <button class="gemini-button flex-1 bg-red-500 hover:bg-red-600" onclick="event.stopPropagation(); deleteProject('${project.id}')"><span class="material-icons">delete</span>Delete</button>
                  </div>
                `;
                card.onclick = () => selectProject(project.id);
                list.appendChild(card);
              });
            }
            function showNewProjectModal() {
              document.getElementById('new-project-modal').classList.add('visible');
              document.getElementById('new-project-form').classList.add('hidden');
              document.getElementById('onboarding-ai').classList.add('hidden');
              document.getElementById('project-name-input').value = '';
              document.getElementById('project-desc-input').value = '';
              window._aiOnboardingPhases = null;
            }
            function hideNewProjectModal() {
              document.getElementById('new-project-modal').classList.remove('visible');
              document.getElementById('project-name-input').value = '';
              document.getElementById('project-desc-input').value = '';
              window._aiOnboardingPhases = null;
            }
            document.getElementById('new-project-btn').onclick = showNewProjectModal;
            document.getElementById('close-new-project-modal').onclick = hideNewProjectModal;
            document.getElementById('guided-onboarding-btn').onclick = () => {
              document.getElementById('onboarding-ai').classList.remove('hidden');
              document.getElementById('new-project-form').classList.add('hidden');
              startAIOnboarding();
            };
            document.getElementById('quick-start-btn').onclick = () => {
              document.getElementById('new-project-form').classList.remove('hidden');
              document.getElementById('onboarding-ai').classList.add('hidden');
              window._aiOnboardingPhases = null;
            };
            document.getElementById('create-project-btn').onclick = () => {
              const name = document.getElementById('project-name-input').value.trim();
              const desc = document.getElementById('project-desc-input').value.trim();
              if (!name) return;
              // Use actual user name
              const userName = ui.userNameInput.value || 'User';
              const phases = window._aiOnboardingPhases || [
                { id: 'phase1', title: 'Phase 1: Foundation', milestones: [ { text: 'Setup Project', status: 'To Do' } ] }
              ];
              const newProject = {
                id: 'proj_' + Date.now(),
                name,
                description: desc,
                status: 'Not Started',
                progress: 0,
                roadmap: {
                  user: { name: userName },
                  activeCoach: 'Jonas',
                  phases,
                  journal: []
                }
              };
              projects.push(newProject);
              saveProjectsToFirestore();
              hideNewProjectModal();
              renderProjectHub();
              window._aiOnboardingPhases = null;
            };
            // --- Reset modal fields on open/close ---
            // --- Firestore CRUD for Projects (Portfolio) ---
async function saveProjectsToFirestore() {
  if (!auth.currentUser) return;
  showLoading('Saving projects...');
  try {
    const user = auth.currentUser;
    const appId = 'default-app-id';
    const docPath = `artifacts/${appId}/users/${user.uid}/projects/state`;
    const ref = db.doc(docPath);
    await ref.set({ projects });
  } catch (e) {
    showErrorModal('Failed to save projects. Please try again.');
    console.error('Error saving projects:', e);
  } finally {
    hideLoading();
  }
}

async function loadProjectsFromFirestore(user) {
  showLoading('Loading projects...');
  const appId = 'default-app-id';
  const docPath = `artifacts/${appId}/users/${user.uid}/projects/state`;
  projectsRef = db.doc(docPath);
  try {
    const docSnap = await projectsRef.get();
    if (docSnap.exists) {
      projects = docSnap.data().projects || [];
    } else {
      projects = [];
      await saveProjectsToFirestore();
    }
    renderProjectHub();
  } catch (e) {
    showErrorModal('Failed to load projects. Please refresh or try again.');
    console.error('Error loading projects:', e);
  } finally {
    hideLoading();
  }
}

function editProject(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;
  document.getElementById('project-name-input').value = project.name;
  document.getElementById('project-desc-input').value = project.description || '';
  showNewProjectModal();
  // Patch create button to update instead
  const createBtn = document.getElementById('create-project-btn');
  createBtn.textContent = 'Save Changes';
  createBtn.onclick = () => {
    const name = document.getElementById('project-name-input').value.trim();
    const desc = document.getElementById('project-desc-input').value.trim();
    if (!name) return;
    project.name = name;
    project.description = desc;
    saveProjectsToFirestore();
    hideNewProjectModal();
    renderProjectHub();
    createBtn.textContent = 'Create Project';
    createBtn.onclick = defaultCreateProjectHandler;
  };
}

function deleteProject(projectId) {
  if (!confirm('Are you sure you want to delete this project? This cannot be undone.')) return;
  projects = projects.filter(p => p.id !== projectId);
  saveProjectsToFirestore();
  renderProjectHub();
}

// Patch create button to restore default handler after edit
const defaultCreateProjectHandler = document.getElementById('create-project-btn').onclick;

// Patch Project Hub cards to add edit/delete buttons

// --- Patch Project Hub navigation to select project and show planner views ---
function selectProject(projectId) {
  selectedProjectId = projectId;
  const project = projects.find(p => p.id === projectId);
  if (!project) return;
  roadmapData = project.roadmap;
  document.getElementById('project-hub-view').classList.remove('active');
  document.getElementById('app-container').classList.remove('hidden');
  renderRoadmap();
  setupNavigation();
}
// --- Patch navigation for Back to Hub button ---
document.getElementById('back-to-hub-btn').onclick = function() {
  renderProjectHub();
};
// --- Patch authentication to load projects on login ---
auth.onAuthStateChanged(async (user) => {
  if (user) {
    console.log('User authenticated, loading projects...');
    await loadProjectsFromFirestore(user);
    console.log('Projects loaded, rendering hub...');
    renderProjectHub();
    console.log('Hub rendered, hiding loading...');
    hideLoading(); // Hide loading screen when authenticated

    // Additional fallback to ensure loading screen is hidden
    const loadingScreen = document.getElementById('loading-screen');
    if (loadingScreen) {
      loadingScreen.style.opacity = '0';
      setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
    }
    // Note: Don't manipulate app-container here, renderProjectHub handles it
  } else {
    console.log('No user, signing in anonymously...');
    await auth.signInAnonymously();
  }
});

// --- Missing utility functions ---
function showLoading(message) {
  ui.loadingScreen.style.display = 'flex';
  ui.loadingScreen.style.opacity = '1';
  const loadingText = ui.loadingScreen.querySelector('h1');
  if (loadingText) loadingText.textContent = message || 'Loading...';
}

function hideLoading() {
  ui.loadingScreen.style.opacity = '0';
  setTimeout(() => { ui.loadingScreen.style.display = 'none'; }, 500);
}

function showErrorModal(message) {
  ui.modalTitle.textContent = "Error";
  ui.modalBody.innerHTML = `<p class="text-red-400">${message}</p>`;
  ui.modal.classList.add('visible');
}

function showImportModal() {
  ui.modalTitle.textContent = "Import Project";
  ui.modalBody.innerHTML = `
    <p class="mb-4">Import a project from a JSON file:</p>
    <input type="file" id="import-file-input" accept=".json" class="mb-4">
    <button id="import-project-btn" class="gemini-button">Import Project</button>
  `;
  ui.modal.classList.add('visible');

  document.getElementById('import-project-btn').onclick = () => {
    const fileInput = document.getElementById('import-file-input');
    const file = fileInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const projectData = JSON.parse(e.target.result);
        projectData.id = 'proj_' + Date.now();
        projects.push(projectData);
        saveProjectsToFirestore();
        ui.modal.classList.remove('visible');
        renderProjectHub();
      } catch (error) {
        showErrorModal('Invalid project file format.');
      }
    };
    reader.readAsText(file);
  };
}

async function startAIOnboarding() {
  const prompt = `You are a project planning expert. Create a simple 3-phase project structure with basic milestones. Return only a JSON array of phases in this exact format: [{"id":"phase1","title":"Phase 1: Planning","milestones":[{"text":"Define requirements","status":"To Do"}]},{"id":"phase2","title":"Phase 2: Development","milestones":[{"text":"Build core features","status":"To Do"}]},{"id":"phase3","title":"Phase 3: Launch","milestones":[{"text":"Deploy and test","status":"To Do"}]}]`;

  const result = await callGemini(prompt);
  if (result) {
    try {
      window._aiOnboardingPhases = JSON.parse(result);
      document.getElementById('onboarding-ai').innerHTML = `
        <p class="mb-2 text-green-400">✓ AI has generated a project structure for you!</p>
        <button id="use-ai-structure" class="gemini-button w-full mb-2">Use AI Structure</button>
        <button id="customize-structure" class="gemini-button w-full">Customize Structure</button>
      `;

      document.getElementById('use-ai-structure').onclick = () => {
        document.getElementById('new-project-form').classList.remove('hidden');
        document.getElementById('onboarding-ai').classList.add('hidden');
      };

      document.getElementById('customize-structure').onclick = () => {
        document.getElementById('new-project-form').classList.remove('hidden');
        document.getElementById('onboarding-ai').classList.add('hidden');
      };
    } catch (e) {
      document.getElementById('onboarding-ai').innerHTML = `<p class="text-red-400">AI onboarding failed. Please use Quick Start instead.</p>`;
    }
  }
}

        });
    </script>
    <script>
      // Confetti animation for phase completion
      function launchConfetti() {
        const confetti = document.createElement('canvas');
        confetti.className = 'confetti';
        document.body.appendChild(confetti);
        const ctx = confetti.getContext('2d');
        confetti.width = window.innerWidth;
        confetti.height = window.innerHeight;
        const pieces = Array.from({length: 120}, () => ({
          x: Math.random() * confetti.width,
          y: Math.random() * -confetti.height,
          r: 6 + Math.random() * 8,
          d: 2 + Math.random() * 2,
          color: `hsl(${Math.random()*360},80%,70%)`,
          tilt: Math.random() * 10 - 5
        }));
        let frame = 0;
        function draw() {
          ctx.clearRect(0,0,confetti.width,confetti.height);
          pieces.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, 2 * Math.PI);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = 0.85;
            ctx.fill();
          });
        }
        function update() {
          frame++;
          pieces.forEach(p => {
            p.y += p.d + Math.sin(frame/10 + p.x/100)*1.5;
            p.x += Math.sin(frame/15 + p.y/80)*2;
            if (p.y > confetti.height) p.y = -10;
          });
        }
        let anim;
        function loop() { draw(); update(); anim = requestAnimationFrame(loop); }
        loop();
        setTimeout(() => { cancelAnimationFrame(anim); confetti.remove(); }, 2200);
      }

      // Immediate fallback: Show project hub and app container
      setTimeout(() => {
          console.log('Fallback: Ensuring app is visible...');
          const hubView = document.getElementById('project-hub-view');
          const loadingScreen = document.getElementById('loading-screen');
          const appContainer = document.getElementById('app-container');

          // Force show the app container
          if (appContainer) {
              appContainer.classList.remove('hidden');
              appContainer.style.display = 'block';
              console.log('App container forced visible');
          }

          // Force show the hub view
          if (hubView) {
              hubView.classList.add('active');
              hubView.style.display = 'block';
              console.log('Hub view forced visible');
          }

          // Hide loading screen
          if (loadingScreen) {
              loadingScreen.style.display = 'none';
              console.log('Loading screen hidden');
          }

          // Force render the hub
          renderProjectHub();
      }, 1000);
    </script>
</body>
</html>